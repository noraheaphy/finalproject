---
title: "Anacamps Ancestral Reconstruction"
author: "Nora Heaphy"
date: "11/24/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ape)
library(ggtree)
library(phytools)
library(tidyverse)
library(ggplot2)
library(phylotools)
library(knitr)

```

## Data cleaning

- First to get all the taxa names in the character data matrix and the phylogeny tip labels into the format *Genus_species*

- Then drop the tips from the tree that don't have an equivalent in the character data (which is many of them) with `drop.tip`

- Then remove the character data rows that don't have an equivalent in the tree with `dplyr`

- Then use this line from exercise 10 to get the character data rows into the right order to map onto the tips: `geoData = geoData[ match( row.names(geoData), geoTree$tip.label  ), ]`

```{r}

# read in tree file
anacampsTree <- read.tree("data/anacamps.treefile")

# read in character data
anacampsData <- read.csv("data/anacamps_means_11-24-2020.csv", header = TRUE, 
                          sep = ",", na.strings = "")

anacampsData$species <- as.factor(anacampsData$species)
anacampsData <- anacampsData %>% mutate(MAT = CHELSA_BIOL_01*0.1)

anacampsTree$tip.label = anacampsTree$tip.label %>%
  str_replace("_", " ") %>%
  str_replace("_.*", "")

# make dataframe of species names from character data
species_character <- data.frame(anacampsData$species) %>%
  rename(names = anacampsData.species)

# make dataframe of species names from tip labels
species_tree <- data.frame(anacampsTree$tip.label) %>%
  rename(names = anacampsTree.tip.label)

# pull out the names in the tree but not the character data
names_to_drop <- setdiff(species_tree, species_character)
names_to_drop <- names_to_drop$names # make into a vector

# remove tips that don't have character data matches
anacampsTree <- drop.tip(anacampsTree, names_to_drop)
anacampsTree <- drop.tip(anacampsTree, c(21,16,17,18,13,22,11,10,9,8)) # monophyletic duplicates
anacampsTree <- drop.tip(anacampsTree, c(2,3,4)) # monophyletic duplicates round 2

# now remove rows from character data frame that don't correspond to tips
species_tree <- data.frame(anacampsTree$tip.label) %>%
  rename(names = anacampsTree.tip.label)

names_to_drop <- setdiff(species_character, species_tree)
names_to_drop <- names_to_drop$names # make into a vector

anacampsData <- anacampsData[!(anacampsData$species %in% names_to_drop),] 

# last check

if(! length(anacampsTree$tip.label) == nrow(anacampsData)) {
      stop("Error: different numbers of taxa in tip labels and character data!")
} else {
  print("All good, continue!")
}

# save this cleaned character data
write.csv(anacampsData, "data/anacamps_means_mapping.csv", row.names = FALSE)

```

```{r fig.width=9, fig.height=18}

# plot tree

ggtree(anacampsTree) + 
  geom_tiplab(fontface = "italic") +
  geom_text2(aes(label = node), col = "red", size = 6)

```


```{r}

# turn first column of character data into row names
row.names(anacampsData) = anacampsData$species

# ensure character data and tiplabels are in same order
anacampsData <- anacampsData[match(anacampsTree$tip.label, row.names(anacampsData)), ]
    
# double check that labels are the same, in case some were missing or duplicated
if(!all(row.names(anacampsData) == anacampsTree$tip.label)){
      stop("Error: tip labels and dataframe rows not in same order!")
} else {
  print("Labels are in the right order, go ahead!")
}

# count the number of tips
n_tips = length(anacampsTree$tip.label)

# root tree manually based on Moore et al 2018
anacampsTree <- root(anacampsTree, node = 28, edgelabel = TRUE)
if(is.rooted(anacampsTree) == FALSE) {
  stop("Error: tree is not rooted.")
} else {
  print("Tree is rooted, continue!")
}

# get the root node by finding the node that is a parent (in column 1 of edge) 
# but not a child (in column 2 of edge)
# root_node = anacampsTree$edge[(!anacampsTree$edge[,1] %in% anacampsTree$edge[,2]),1] %>%
#  unique()
root_node = 28 # temporarily assigning manually because I can't get it to work the other way

# get the maximum distance from the root to another node, which will be for a tip.
# since this tree happens to be ultrametric, this will be the root age
root_age = max(dist.nodes(anacampsTree)[, root_node])

# this isn't necessary, but since we don't know the units of edge length let's rescale
# the tree so that the age of the root is 1.
# this could be a place to add noise into edge lengths to see how robust the analysis is
anacampsTree$edge.length = anacampsTree$edge.length/root_age
    
# and now recalculate the root age to make sure things look good
root_age = max(dist.nodes(anacampsTree)[, root_node])
    
```